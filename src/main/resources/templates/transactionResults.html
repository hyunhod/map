<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c74df985d80b0746ec2b535f9e18c2a1&libraries=services,drawing"></script>
    <style>
        #map {
            width: 100%;
            height: 400px; /* Adjust as needed */
            margin-top: 20px; /* Space between table and map */
        }
        #info {
            width: 200px;
            height: 400px;
            float: left;
            padding: 10px;
            border-left: 1px solid #ccc;
        }
        #address-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        .address-item {
            padding: 5px;
            cursor: pointer;
        }
        .address-item:hover {
            background-color: #f0f0f0;
        }
        .apt-name {
            cursor: pointer; /* Pointer 커서 추가 */
            color: blue; /* 링크처럼 보이도록 색상 변경 */
            text-decoration: underline; /* 밑줄 추가 */
        }
    </style>
</head>
<body>

<!-- Kakao Map -->
<div id="map"></div>

<input type="text" id="address" placeholder="주소를 입력하세요" style="width:400px;"/>
<button onclick="searchAddress()">주소 검색</button>

<div id="address-list"></div>
<!-- 그래프를 표시할 캔버스 -->
<canvas id="priceChart" width="400" height="200"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청 좌표
            level: 3
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);
    var geocoder = new kakao.maps.services.Geocoder();
    var marker = new kakao.maps.Marker();

    // 주소로 좌표를 검색하는 함수
    function searchAddress() {
        var address = document.getElementById('address').value;

        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                marker.setPosition(coords);
                marker.setMap(map);
                map.setCenter(coords);
                console.log("위도:", result[0].y, "경도:", result[0].x);
            } else {
                alert('주소를 찾을 수 없습니다.');
            }
        });
    }

    // 선택한 아파트를 지도에 표시하는 함수
    function showOnMap(umdNm, jibun,aptNm) {
        var address = umdNm + " " + jibun; // 법정동 + 지번
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                marker.setPosition(coords);
                marker.setMap(map);
                map.setCenter(coords);
                console.log("위도:", result[0].y, "경도:", result[0].x);
                fetchPriceHistory(aptNm)

            } else {
                alert('주소를 찾을 수 없습니다.');
            }
        });
    }


   let priceChart; // 차트 전역 변수

function fetchPriceHistory(aptNm) {
    fetch(`/price-history?aptNm=${encodeURIComponent(aptNm)}`)
        .then(response => response.json())
        .then(data => {
            // 날짜와 가격 데이터를 배열로 변환
            const labels = data.map(transaction => `${transaction.dealYear}-${transaction.dealMonth}-${transaction.dealDay}`);
            const prices = data.map(transaction => transaction.dealAmount / 10000); // 억 단위로 변환

            // 이전 차트가 존재하면 파괴
            if (priceChart) {
                priceChart.destroy();
            }

            // Chart.js를 이용해 그래프 그리기
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '매매가(억 원)',
                        data: prices,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '거래일자'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '가격(억 원)'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('가격 기록을 가져오는 중 오류 발생:', error);
        });
}


    // 지역 코드를 가져오는 함수
    function getRegionCode(region) {
        const dealDate = document.getElementById('dealDate').value;
        fetch(`https://apis.data.go.kr/1741000/StanReginCd/getStanReginCdList?ServiceKey=YOUR_SERVICE_KEY&type=xml&pageNo=1&numOfRows=3&flag=Y&locatadd_nm=${encodeURIComponent(region)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('네트워크 오류');
                }
                return response.text();
            })
            .then(xmlData => {
                const regionCodes = [...new Set(parseRegionCodes(xmlData))];  // 중복 제거
                if (regionCodes.length > 0) {
                    regionCodes.forEach(code => fetchApartments(code, dealDate));
                } else {
                    alert('유효한 지역 코드를 찾을 수 없습니다.');
                }
            })
            .catch(error => {
                console.error('지역 코드 검색 오류:', error);
            });
    }
</script>

<div class="container mt-5">
    <h2>검색 결과</h2>
    <!-- 홈 버튼 -->
    <a href="/" class="btn btn-primary mb-3">홈</a>

    <table class="table">
        <thead>
        <tr>
            <th>이름</th>
            <th>건축년도</th>
            <th>가격</th>
            <th>전용면적</th>
            <th>거래일자</th>
            <th>층</th>
            <th>법정동</th>
            <th>지번</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="ranking : ${transactions}">
            <td>
                <span class="apt-name"
                      th:text="${ranking.aptNm}"
                      th:attr="onclick='showOnMap(\'' + ${ranking.umdNm} + '\', \'' + ${ranking.jibun} + '\', \'' + ${ranking.aptNm} + '\')'"></span>
            </td>
            <td th:text="${ranking.buildYear}"></td>
            <td th:text="${ranking.dealAmount/10000 +'억'}"></td>
            <td th:text="${ranking.excluUseAr}"></td>
            <td th:text="${ranking.dealYear} + '-' + ${ranking.dealMonth} + '-' + ${ranking.dealDay}"></td>
            <td th:text="${ranking.floor}"></td>
            <td th:text="${ranking.umdNm}"></td>
            <td th:text="${ranking.jibun}"></td>
        </tr>
        </tbody>
    </table>

    <!-- 페이징 링크 -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link" th:href="@{/search1(locationName=${locationName},minPrice=${minPrice}, maxPrice=${maxPrice}, minArea=${minArea},maxArea=${maxArea},dealDate=${dealDate},sortBy=${sortBy},page=${currentPage - 1}, size=${size})}">이전</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(T(java.lang.Math).max(0, currentPage - 2), T(java.lang.Math).min(totalPages - 1, currentPage + 2))}"
                th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link" th:href="@{/search1(locationName=${locationName},minPrice=${minPrice}, maxPrice=${maxPrice}, minArea=${minArea},maxArea=${maxArea},dealDate=${dealDate},sortBy=${sortBy},page=${i}, size=${size})}" th:text="${i + 1}">1</a>
            </li>
            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                <a class="page-link" th:href="@{/search1(locationName=${locationName},minPrice=${minPrice}, maxPrice=${maxPrice}, minArea=${minArea},maxArea=${maxArea},dealDate=${dealDate},sortBy=${sortBy},page=${currentPage + 1}, size=${size})}">다음</a>
            </li>
        </ul>
    </nav>
</div>

</body>
</html>
