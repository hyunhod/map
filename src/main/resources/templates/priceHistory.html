<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c74df985d80b0746ec2b535f9e18c2a1&libraries=services,drawing"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .search-form {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-form input,
        .search-form select,
        .search-form button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-form button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        .search-form button:hover {
            background-color: #0056b3;
        }
        #map {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
        #info {
            width: 200px;
            height: 400px;
            float: left;
            padding: 10px;
            border-left: 1px solid #ccc;
        }
        #address-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        .address-item {
            padding: 5px;
            cursor: pointer;
        }
        .address-item:hover {
            background-color: #f0f0f0;
        }
        .apt-name {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
        .chart-container {
            height: 400px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2>거래 검색</h2>
    <form action="/aptSearch" method="GET">
        <div class="form-row">
            <div class="form-group col-md-1">
                <label for="region">지역</label>
                <select id="region" name="region" class="form-control" required>
                    <option value="">선택하세요</option>
                    <th:block th:each="entry : ${locations}">
                        <option th:value="${entry.value}" th:text="${entry.key}"></option>
                    </th:block>
                </select>
            </div>
            <div class="form-group col-md-1">
                <label for="locationName">세부 지역</label>
                <select id="locationName" name="locationName" class="form-control" required>
                    <option value="">선택하세요</option>
                </select>
            </div>
            <div class="form-group col-md-1 align-self-end">
                <button type="submit" class="btn btn-primary btn-block">검색</button>
            </div>
        </div>
    </form>
</div>

<div class="container mt-5">
    <div id="map"></div>
    <input type="text" id="address" placeholder="번지-지번 검색" style="width:400px;"/>
    <button onclick="searchAddress()" class="btn btn-secondary">주소 검색</button>
    <div id="address-list"></div>

    <div class="row mt-4">
        <div class="col-md-8">
            <table class="table">
                <thead>
                <tr>
                    <th>아파트 이름</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="aptNm : ${apartmentNames}">
                    <td>
                        <a href="#"
                           th:text="${aptNm}"
                           th:data-apt-nm="${aptNm}"
                           th:onclick="'loadApartmentDetails(this.dataset.aptNm)'">
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="apartment-details"></div>
    </div>

    <a href="/" class="btn btn-primary mb-3">홈</a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const links = document.querySelectorAll('a[data-apt-nm]');
        links.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const apartmentName = this.dataset.aptNm;
                loadApartmentDetails(apartmentName);
            });
        });
    });

    function loadApartmentDetails(apartmentName) {
        fetch('/getApartmentDetails?name=' + encodeURIComponent(apartmentName))
        .then(response => response.json())
        .then(data => {
            showOnMap(data.umdNm, data.jibun, apartmentName);
        })
        .catch(error => {
            console.error('Error fetching apartment details:', error);
        });
    }

    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 3
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);
    var geocoder = new kakao.maps.services.Geocoder();
    var marker = new kakao.maps.Marker();

    function searchAddress() {
        var address = document.getElementById('address').value;
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                marker.setPosition(coords);
                marker.setMap(map);
                map.setCenter(coords);
            } else {
                alert('주소를 찾을 수 없습니다.');
            }
        });
    }

    $(document).ready(function() {
        $('#region').change(function() {
            var regionCode = $(this).val();
            $('#locationName').empty().append('<option value="">선택하세요</option>');
            if (regionCode) {
                $.get('/sub-locations', { regionCode: regionCode }, function(data) {
                    data.forEach(function(loc) {
                        $('#locationName').append('<option value="' + loc + '">' + loc + '</option>');
                    });
                });
            }
        });
    });

    function showOnMap(umdNm, jibun, aptNm) {
        var address = umdNm + " " + jibun;
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                marker.setPosition(coords);
                marker.setMap(map);
                map.setCenter(coords);
                fetchPriceHistory(aptNm);
            } else {
                alert('주소를 찾을 수 없습니다.');
            }
        });
    }

    function fetchPriceHistory(aptNm) {
        fetch(`/price-history?aptNm=${encodeURIComponent(aptNm)}`)
            .then(response => response.json())
            .then(data => {
                const detailsDiv = document.getElementById('apartment-details');


                detailsDiv.innerHTML = `
                    <h3>${aptNm} 거래 정보</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>건축년도</th>
                                <th>가격</th>
                                <th>전용면적</th>
                                <th>거래일자</th>
                                <th>층</th>
                                <th>법정동</th>
                                <th>지번</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(transaction => `
                                <tr>
                                    <td>${transaction.buildYear}</td>
                                    <td>${transaction.dealAmount / 10000}억</td>
                                    <td>${transaction.excluUseAr}</td>
                                    <td>${transaction.dealYear}-${transaction.dealMonth}-${transaction.dealDay}</td>
                                    <td>${transaction.floor}</td>
                                    <td>${transaction.umdNm}</td>
                                    <td>${transaction.jibun}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            })
            .catch(error => {
                console.error('Error fetching apartment price history:', error);
            });
    }

    // 페이징 링크를 추가하는 부분
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
