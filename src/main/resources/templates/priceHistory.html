<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c74df985d80b0746ec2b535f9e18c2a1&libraries=services,drawing"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .search-form {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-form input,
        .search-form select,
        .search-form button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-form button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        .search-form button:hover {
            background-color: #0056b3;
        }

        #map {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        #info {
            width: 200px;
            height: 400px;
            float: left;
            padding: 10px;
            border-left: 1px solid #ccc;
        }

        #address-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-top: 10px;
        }

        .address-item {
            padding: 5px;
            cursor: pointer;
        }

        .address-item:hover {
            background-color: #f0f0f0;
        }

        .apt-name {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }

        .chart-container {
            height: 400px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2>거래 검색</h2>
    <form action="/aptSearch" method="GET">
        <div class="form-row">
            <div class="form-group col-md-1">
                <label for="region">지역</label>
                <select id="region" name="region" class="form-control" required>
                    <option value="">선택하세요</option>
                    <th:block th:each="entry : ${locations}">
                        <option th:value="${entry.value}" th:text="${entry.key}"></option>
                    </th:block>
                </select>
            </div>
            <div class="form-group col-md-1">
                <label for="locationName">세부 지역</label>
                <select id="locationName" name="locationName" class="form-control" required>
                    <option value="">선택하세요</option>
                </select>
            </div>
            <div class="form-group col-md-1">
                <label for="minPrice">최소 가격</label>
                <input type="number" class="form-control" id="minPrice" name="minPrice" placeholder="최소 가격">
            </div>
            <div class="form-group col-md-1">
                <label for="maxPrice">최대 가격</label>
                <input type="number" class="form-control" id="maxPrice" name="maxPrice" placeholder="최대 가격">
            </div>
            <div class="form-group col-md-2">
                <label for="minArea" class="text-nowrap">최소 면적 (㎡)</label>
                <input type="number" class="form-control" id="minArea" name="minArea" placeholder="최소 면적">
            </div>
            <div class="form-group col-md-2">
                <label for="maxArea" class="text-nowrap">최대 면적 (㎡)</label>
                <input type="number" class="form-control" id="maxArea" name="maxArea" placeholder="최대 면적">
            </div>
            <div class="form-group col-md-2">
                <label for="dealDate">거래 날짜</label>
                <input type="date" class="form-control" id="dealDate" name="dealDate">
            </div>
            <div class="form-group col-md-1">
                <label for="sortBy">정렬 기준</label>
                <select id="sortBy" name="sortBy" class="form-control">
                    <option value="">선택하세요</option>
                    <option value="dealAmount">거래 금액순</option>
                    <option value="buildYear">건축년도순</option>
                </select>
            </div>
            <div class="form-group col-md-1 align-self-end">
                <button type="submit" class="btn btn-primary btn-block">검색</button>
            </div>
        </div>
    </form>
</div>

<div class="container mt-5">
    <div id="map"></div>
    <input type="text" id="address" placeholder="번지-지번 검색" style="width:400px;"/>
    <button onclick="searchAddress()" class="btn btn-secondary">주소 검색</button>
    <div id="address-list"></div>

    <div class="row mt-4">
        <div class="col-md-8">
            <table class="table">
                <thead>
                <tr>
                    <th>아파트 이름</th>
                    <th>건축년도</th>
                    <th>법정동</th>
                    <th>지번</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="apt : ${apartmentNames}">
                    <td>
                        <a href="#"
                           th:text="${apt}"
                           th:data-apt-nm="${apt}"
                           th:onclick="'loadApartmentDetails(this.dataset.aptNm)'">
                        </a>
                    </td>
                    <td colspan="3">
                        <table>
                            <tbody>
                            <tr th:if="${apartmentDetails[apt.toString()] != null}">
                                <td th:text="${apartmentDetails[apt.toString()][0].buildYear}"></td>
                                <td th:text="${apartmentDetails[apt.toString()][0].umdNm}"></td>
                                <td th:text="${apartmentDetails[apt.toString()][0].jibun}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="apartment-details"></div>
    </div>

    <div class="chart-container">
        <canvas id="priceChart"></canvas>
    </div>

    <a href="/" class="btn btn-primary mb-3">홈</a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const links = document.querySelectorAll('a[data-apt-nm]');
        links.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const apartmentName = this.dataset.aptNm;
                loadApartmentDetails(apartmentName);
            });
        });
    });

    function loadApartmentDetails(apartmentName) {
        fetch('/getApartmentDetails?name=' + encodeURIComponent(apartmentName))
        .then(response => response.json())
        .then(data => {
            showOnMap(data.umdNm, data.jibun, apartmentName);
        })
        .catch(error => {
            console.error('Error fetching apartment details:', error);
        });
    }

    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 3
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);
    var geocoder = new kakao.maps.services.Geocoder();
    var marker = new kakao.maps.Marker();

    function searchAddress() {
        var address = document.getElementById('address').value;
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                marker.setPosition(coords);
                marker.setMap(map);
                map.setCenter(coords);
            } else {
                alert('주소를 찾을 수 없습니다.');
            }
        });
    }

    $(document).ready(function() {
        $('#region').change(function() {
            var regionCode = $(this).val();
            $('#locationName').empty().append('<option value="">선택하세요</option>');
            if (regionCode) {
                $.get('/sub-locations', { regionCode: regionCode }, function(data) {
                    data.forEach(function(loc) {
                        $('#locationName').append('<option value="' + loc + '">' + loc + '</option>');
                    });
                });
            }
        });
    });

    function showOnMap(umdNm, jibun, aptNm) {
        var address = umdNm + " " + jibun;
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                marker.setPosition(coords);
                marker.setMap(map);
                map.setCenter(coords);
                fetchPriceHistory(aptNm);
            } else {
                alert('주소를 찾을 수 없습니다.');
            }
        });
    }


    // Chart.js를 이용해 그래프 그리기
let priceChart; // 차트 전역 변수

// 가격 이력을 가져오는 함수
function fetchPriceHistory(aptNm) {
    fetch(`/price-history?aptNm=${encodeURIComponent(aptNm)}`)
        .then(response => response.json())
        .then(data => {
            const detailsDiv = document.getElementById('apartment-details');

            // 거래 데이터를 월별로 집계
            const monthlyData = {};
            data.forEach(transaction => {
                const monthKey = `${transaction.dealYear}-${transaction.dealMonth}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { total: 0, count: 0 };
                }
                monthlyData[monthKey].total += transaction.dealAmount;
                monthlyData[monthKey].count++;
            });

            // 월별 평균 가격 계산
            const labels = [];
            const prices = [];
            for (const month in monthlyData) {
                labels.push(month);
                prices.push(monthlyData[month].total / monthlyData[month].count / 10000); // 억 단위로 변환
            }

            // 이전 차트가 존재하면 파괴
            if (priceChart) {
                priceChart.destroy();
            }

            // Chart.js를 이용해 그래프 그리기
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '아파트 가격 (억원)',
                        data: prices,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '가격 (억원)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '날짜'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching price history:', error);
        });
}
//이름 불러오기
function loadApartmentDetails(apartmentName) {
    const detailsDiv = document.getElementById('apartment-details');
    detailsDiv.innerHTML = `<h2>${apartmentName}</h2>`;

    // 아파트 상세 정보 가져오기
    fetch('/getApartmentDetails?name=' + encodeURIComponent(apartmentName))
        .then(response => response.json())
        .then(data => {
        console.log(data.transactions);

         // detailsDiv 초기화
        detailsDiv.innerHTML = ''; // 내용을 비워서 이전 데이터를 제거

            if (!data || !data.transactions || data.transactions.length === 0) {
                detailsDiv.innerHTML += `<p>거래 정보가 없습니다.</p>`;
                return;
            }

            // 추가적인 아파트 상세 정보 표시
            detailsDiv.innerHTML += `
                <table class="table">
                    <thead>
                        <tr>
                            <th>건축년도</th>
                            <th>가격</th>
                            <th>전용면적</th>
                            <th>거래일자</th>
                            <th>층</th>
                            <th>법정동</th>
                            <th>지번</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.transactions.map(transaction => `
                            <tr>
                                <td>${transaction.buildYear}</td>
                                <td>${transaction.dealAmount / 10000}억</td>
                                <td>${transaction.excluUseAr}</td>
                                <td>${transaction.dealYear}-${transaction.dealMonth}-${transaction.dealDay}</td>
                                <td>${transaction.floor}</td>
                                <td>${transaction.umdNm}</td>
                                <td>${transaction.jibun}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        })
        .catch(error => {
            console.error('Error fetching apartment details:', error);
            detailsDiv.innerHTML += `<p>상세 정보를 불러오는 데 오류가 발생했습니다.</p>`;
        });
    // 가격 이력 불러오기
    fetchPriceHistory(apartmentName);
}

// DOMContentLoaded 이벤트가 발생했을 때의 코드
document.addEventListener('DOMContentLoaded', function() {
    const links = document.querySelectorAll('a[data-apt-nm]');
    links.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            const apartmentName = this.dataset.aptNm;
            loadApartmentDetails(apartmentName);
        });
    });
});
</script>
</body>
</html>
